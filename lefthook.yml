# lefthook.yml - Git hooks configuration
# Replaces Husky with a faster, dependency-free alternative
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: false
  commands:
    markdown-lint:
      glob: "*.md"
      run: |
        # Get staged markdown files
        STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)
        if [ -n "$STAGED_MD" ]; then
          COUNT=$(echo "$STAGED_MD" | wc -l | tr -d ' ')
          echo "üìù Validating $COUNT markdown file(s)..."
          # Lint staged files only, suppress verbose Finding: output
          RESULT=$(echo "$STAGED_MD" | xargs markdownlint-cli2 --no-globs 2>&1)
          # Show only Summary and errors, skip Finding/Linting lines
          echo "$RESULT" | grep -v -E '^(Finding:|Linting:)' || true
        else
          echo "‚ÑπÔ∏è  No markdown files to validate"
        fi
      stage_fixed: true

    link-check:
      glob: "docs/**/*.md"
      run: |
        # Get staged docs markdown files, excluding _superseded
        STAGED_DOCS=$(git diff --cached --name-only --diff-filter=ACM | grep '^docs/.*\.md$' | grep -v '_superseded' || true)
        if [ -n "$STAGED_DOCS" ]; then
          echo "üîó Checking links in $(echo "$STAGED_DOCS" | wc -l | tr -d ' ') doc file(s)..."
          # Use npx to run from local node_modules (avoids Node.js 24 global install bug)
          echo "$STAGED_DOCS" | xargs -I {} npx markdown-link-check {} --config .markdown-link-check.json --quiet
        else
          echo "‚ÑπÔ∏è  No docs to check links"
        fi

    artifact-validation:
      glob: "agent-output/**/*.md"
      run: |
        # Check if any agent-output artifacts are staged
        STAGED_ARTIFACTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^agent-output/.*\.md$' || true)
        if [ -n "$STAGED_ARTIFACTS" ]; then
          COUNT=$(echo "$STAGED_ARTIFACTS" | wc -l | tr -d ' ')
          echo "üìã Validating $COUNT artifact(s) against templates..."
          # Run full artifact validation - blocks on any H2 mismatch
          if ! npm run lint:artifact-templates; then
            echo ""
            echo "‚ùå Artifact template validation failed!"
            echo ""
            echo "üîß To fix:"
            echo "   1. Check .github/instructions/artifact-h2-reference.instructions.md"
            echo "   2. Use EXACT H2 headings from that file"
            echo "   3. Run: npm run fix:artifact-h2 <file> --apply"
            echo "   4. Re-stage and commit"
            echo ""
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è  No agent-output artifacts to validate"
        fi
      fail_text: |
        ‚ùå Artifact H2 structure validation failed!

        üìö Reference: .github/instructions/artifact-h2-reference.instructions.md
        üîß Auto-fix: npm run fix:artifact-h2 <file> --apply

    agent-frontmatter:
      glob: "**/*.agent.md"
      run: |
        # Check if any agent files are staged
        STAGED_AGENTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.agent\.md$' || true)
        if [ -n "$STAGED_AGENTS" ]; then
          COUNT=$(echo "$STAGED_AGENTS" | wc -l | tr -d ' ')
          echo "ü§ñ Validating $COUNT agent file(s)..."
          npm run lint:agent-frontmatter
        else
          echo "‚ÑπÔ∏è  No agent files to validate"
        fi
      fail_text: |
        ‚ùå Agent frontmatter validation failed!

        üîß Check YAML syntax in agent definitions
        üìö Reference: .github/instructions/agents-definitions.instructions.md

commit-msg:
  commands:
    commitlint:
      run: npx --no -- commitlint --edit {1}
      fail_text: |
        ‚ùå Commit message validation failed!

        üìñ Conventional Commits format required:
           <type>[optional scope]: <description>

           Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert

           Examples:
             feat: add new Azure App Service module
             fix(bicep): correct storage account naming
             docs: update README with deployment steps

# New validation checks (warn mode until 2026-02-10)
# TODO: Change to blocking after 2026-02-10
post-commit:
  commands:
    version-sync:
      run: |
        echo "üîç Checking version synchronization..."
        node scripts/validate-version-sync.mjs || echo "‚ö†Ô∏è  Version sync check failed (warn mode)"
      fail_text: "Version sync warning - will enforce after 2026-02-10"

    deprecated-refs:
      glob: "*.md"
      run: |
        echo "üîç Checking for deprecated references..."
        node scripts/validate-no-deprecated-refs.mjs || echo "‚ö†Ô∏è  Deprecated refs check failed (warn mode)"
      fail_text: "Deprecated references warning - will enforce after 2026-02-10"

    json-syntax:
      glob: "*.json"
      run: |
        echo "üîç Validating JSON syntax..."
        STAGED_JSON=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' | grep -v node_modules | grep -v infra || true)
        if [ -n "$STAGED_JSON" ]; then
          for f in $STAGED_JSON; do
            node -e "JSON.parse(require('fs').readFileSync('$f'))" 2>/dev/null && echo "  ‚úì $f" || echo "  ‚úó $f - Invalid JSON"
          done
        fi
      fail_text: "JSON syntax warning - will enforce after 2026-02-10"
