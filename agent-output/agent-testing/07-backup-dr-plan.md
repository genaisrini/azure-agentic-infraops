# Step 7: Backup & Disaster Recovery Plan - agent-testing

> Generated by azure-workload-docs skill | 2026-02-04
> **Environment**: Development | **Classification**: Non-Production

> [!NOTE]
> ðŸ“š See [documentation-styling.md](../../.github/agents/_shared/documentation-styling.md) for visual standards.

## Executive Summary

This document outlines the backup and disaster recovery (DR) procedures for the agent-testing
infrastructure deployed in Azure. As a development/testing environment, the RTO/RPO targets
are relaxed compared to production systems.

| Metric                             | Target   | Justification                            |
| ---------------------------------- | -------- | ---------------------------------------- |
| **RTO (Recovery Time Objective)**  | 4 hours  | Dev environment, business hours recovery |
| **RPO (Recovery Point Objective)** | 24 hours | Acceptable data loss for testing         |
| **MTTR (Mean Time to Recovery)**   | 2 hours  | Bicep-based rebuild capability           |

## 1. Recovery Objectives

### Tiered Recovery

| Tier   | Resources                                | RTO     | RPO             | Priority |
| ------ | ---------------------------------------- | ------- | --------------- | -------- |
| Tier 1 | SQL Database, Key Vault                  | 2 hours | 24 hours        | High     |
| Tier 2 | App Service, Container App               | 4 hours | N/A (stateless) | Medium   |
| Tier 3 | Static Web App, Service Bus              | 4 hours | N/A             | Low      |
| Tier 4 | Monitoring (Log Analytics, App Insights) | 8 hours | 7 days          | Low      |

### Data Classification

| Data Type           | Location        | Backup Required     | Retention |
| ------------------- | --------------- | ------------------- | --------- |
| Application secrets | Key Vault       | Yes (soft delete)   | 90 days   |
| Application data    | SQL Database    | Yes (Azure-managed) | 7 days    |
| Blob storage        | Storage Account | Yes (soft delete)   | 7 days    |
| Application logs    | Log Analytics   | No                  | 30 days   |
| Queue messages      | Service Bus     | No (transient)      | N/A       |

## 2. Backup Strategy

### Azure-Managed Backups

| Resource        | Backup Type   | Frequency   | Retention | Location           |
| --------------- | ------------- | ----------- | --------- | ------------------ |
| SQL Database    | Point-in-time | Continuous  | 7 days    | Local (Basic tier) |
| Storage Account | Soft delete   | On deletion | 7 days    | Same region        |
| Key Vault       | Soft delete   | On deletion | 90 days   | Same region        |

### Infrastructure as Code Backup

| Component             | Location                     | Recovery Method |
| --------------------- | ---------------------------- | --------------- |
| Bicep templates       | `infra/bicep/agent-testing/` | Git repository  |
| Deployment parameters | `main.bicepparam`            | Git repository  |
| Configuration         | `modules/*.bicep`            | Git repository  |

### Backup Verification

```bash
# Verify SQL Database backup
az sql db list-restore-points \
  --name sqldb-agenttest-dev \
  --server sql-agenttest-dev-swc-rqze4t \
  --resource-group rg-agenttest-dev

# Verify Storage Account soft delete
az storage blob service-properties show \
  --account-name stagenttestdevrqze4t \
  --query "deleteRetentionPolicy"

# Verify Key Vault soft delete
az keyvault show --name kv-agenttes-dev-rqze4t --query "properties.enableSoftDelete"
```

## 3. Disaster Recovery Procedures

### Scenario 1: Single Resource Failure

**Trigger**: Individual resource becomes unavailable or corrupted.

**Procedure**:

1. Identify affected resource from Azure Portal or alerts
2. Attempt restart/restore using runbook procedures
3. If restore fails, redeploy from Bicep:

```bash
cd infra/bicep/agent-testing
az deployment group create \
  --resource-group rg-agenttest-dev \
  --template-file main.bicep \
  --parameters main.bicepparam
```

### Scenario 2: Resource Group Deletion

**Trigger**: Entire resource group accidentally deleted.

**Procedure**:

1. **Create new resource group**:

   ```bash
   az group create --name rg-agenttest-dev --location swedencentral
   ```

2. **Deploy infrastructure from Bicep**:

   ```bash
   cd infra/bicep/agent-testing
   ./deploy.ps1
   ```

3. **Restore data** (if applicable):
   - Key Vault: Recover from soft delete
   - SQL: Restore from backup (if within retention)
   - Storage: Recover from soft delete

4. **Verify deployment**:
   ```bash
   az resource list --resource-group rg-agenttest-dev -o table
   ```

### Scenario 3: Region Outage

**Trigger**: Azure swedencentral region unavailable.

**Procedure**:

1. **Update Bicep parameters for alternate region**:

   ```bicep
   param location = 'germanywestcentral'
   ```

2. **Create resource group in alternate region**:

   ```bash
   az group create --name rg-agenttest-dev-dr --location germanywestcentral
   ```

3. **Deploy to alternate region**:

   ```bash
   az deployment group create \
     --resource-group rg-agenttest-dev-dr \
     --template-file main.bicep \
     --parameters location=germanywestcentral
   ```

4. **Note**: Data will not be available in alternate region unless geo-replicated.

## 4. Testing Schedule

| Test Type               | Frequency | Last Tested | Next Due   |
| ----------------------- | --------- | ----------- | ---------- |
| Backup verification     | Monthly   | 2026-02-04  | 2026-03-04 |
| Single resource restore | Quarterly | -           | 2026-05-04 |
| Full DR drill           | Annually  | -           | 2027-02-04 |
| Runbook validation      | Monthly   | 2026-02-04  | 2026-03-04 |

### Test Procedure: SQL Database Restore

```bash
# 1. List available restore points
az sql db list-restore-points \
  --name sqldb-agenttest-dev \
  --server sql-agenttest-dev-swc-rqze4t \
  --resource-group rg-agenttest-dev

# 2. Restore to a new database
az sql db restore \
  --dest-name sqldb-agenttest-dev-restored \
  --name sqldb-agenttest-dev \
  --server sql-agenttest-dev-swc-rqze4t \
  --resource-group rg-agenttest-dev \
  --time "2026-02-04T12:00:00Z"

# 3. Verify restored database
az sql db show --name sqldb-agenttest-dev-restored \
  --server sql-agenttest-dev-swc-rqze4t \
  --resource-group rg-agenttest-dev

# 4. Delete test restore (cleanup)
az sql db delete --name sqldb-agenttest-dev-restored \
  --server sql-agenttest-dev-swc-rqze4t \
  --resource-group rg-agenttest-dev --yes
```

## 5. Communication Plan

### Incident Notification

| Severity | Notification Method | Recipients                 |
| -------- | ------------------- | -------------------------- |
| P1       | Teams/Slack + Email | Platform Team, DevOps Lead |
| P2       | Teams/Slack         | Platform Team              |
| P3       | Email               | Platform Team              |
| P4       | Ticket only         | Assigned engineer          |

### Status Updates

- **P1**: Every 30 minutes until resolved
- **P2**: Every 2 hours until resolved
- **P3/P4**: Daily until resolved

## 6. Roles and Responsibilities

| Role               | Responsibility       | Contact           |
| ------------------ | -------------------- | ----------------- |
| Incident Commander | Overall coordination | DevOps Lead       |
| Technical Lead     | Recovery execution   | Platform Engineer |
| Communications     | Stakeholder updates  | Project Manager   |
| Documentation      | Post-incident report | Technical Writer  |

## 7. Dependencies

### Internal Dependencies

| Dependency     | Impact if Unavailable   | Mitigation          |
| -------------- | ----------------------- | ------------------- |
| Azure CLI      | Cannot execute recovery | Use Azure Portal    |
| Git repository | No Bicep templates      | Offline backup      |
| Azure AD       | Cannot authenticate     | Wait for resolution |

### External Dependencies

| Dependency     | Provider  | SLA   |
| -------------- | --------- | ----- |
| Azure Platform | Microsoft | 99.9% |
| GitHub (code)  | GitHub    | 99.9% |

## 8. Recovery Runbooks

### Runbook: Key Vault Secret Recovery

```bash
# 1. List deleted secrets
az keyvault secret list-deleted --vault-name kv-agenttes-dev-rqze4t

# 2. Recover specific secret
az keyvault secret recover --vault-name kv-agenttes-dev-rqze4t --name <secret-name>

# 3. Verify recovery
az keyvault secret show --vault-name kv-agenttes-dev-rqze4t --name <secret-name>
```

### Runbook: Storage Blob Recovery

```bash
# 1. List deleted blobs
az storage blob list --account-name stagenttestdevrqze4t --container-name <container> --include d

# 2. Undelete blob
az storage blob undelete --account-name stagenttestdevrqze4t --container-name <container> --name <blob>
```

### Runbook: Full Infrastructure Rebuild

```bash
# 1. Navigate to Bicep directory
cd /workspaces/azure-agentic-infraops/infra/bicep/agent-testing

# 2. Get SQL admin Object ID
SQL_ADMIN_OID=$(az ad signed-in-user show --query id -o tsv)

# 3. Deploy infrastructure
az deployment group create \
  --resource-group rg-agenttest-dev \
  --template-file main.bicep \
  --parameters \
    location=swedencentral \
    environment=dev \
    projectName=agenttest \
    sqlAdminGroupObjectId=$SQL_ADMIN_OID

# 4. Verify deployment
az resource list --resource-group rg-agenttest-dev -o table
```

## 9. Appendix

### Recovery Time Estimates

| Scenario                     | Estimated Time |
| ---------------------------- | -------------- |
| Single resource restart      | 5-15 minutes   |
| Single resource redeploy     | 15-30 minutes  |
| Full infrastructure redeploy | 30-60 minutes  |
| SQL point-in-time restore    | 15-45 minutes  |
| Region failover              | 2-4 hours      |

### Key Vault URIs

- Production: https://kv-agenttes-dev-rqze4t.vault.azure.net/

### Important Azure Resource IDs

```
Subscription: 00858ffc-dded-4f0f-8bbf-e17fff0d47d9
Resource Group: rg-agenttest-dev
```

---

## References

| Topic            | Link                                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------------------- |
| Azure Backup     | [Overview](https://learn.microsoft.com/azure/backup/backup-overview)                                    |
| RTO/RPO Guidance | [Reliability Metrics](https://learn.microsoft.com/azure/well-architected/reliability/metrics)           |
| DR Planning      | [Business Continuity](https://learn.microsoft.com/azure/well-architected/reliability/disaster-recovery) |

---

_Backup & DR plan generated for agent-testing infrastructure._
