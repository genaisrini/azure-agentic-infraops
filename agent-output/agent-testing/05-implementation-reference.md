# Step 5: Implementation Reference - agent-testing

> Generated by bicep-code agent | 2025-02-04
> **Confidence Level**: High

> [!NOTE]
> ðŸ“š See [documentation-styling.md](../../.github/agents/_shared/documentation-styling.md) for visual standards.

## Bicep Templates Location

All infrastructure code is located in:

```
infra/bicep/agent-testing/
```

## File Structure

```
infra/bicep/agent-testing/
â”œâ”€â”€ main.bicep              # Orchestration template (entry point)
â”œâ”€â”€ main.bicepparam         # Parameters file (default values)
â”œâ”€â”€ deploy.ps1              # Deployment script with validation
â””â”€â”€ modules/
    â”œâ”€â”€ monitoring.bicep    # Log Analytics + Application Insights
    â”œâ”€â”€ security.bicep      # Key Vault
    â”œâ”€â”€ storage.bicep       # Storage Account
    â”œâ”€â”€ compute-appservice.bicep  # App Service Plan + App Service
    â”œâ”€â”€ compute-container.bicep   # Container Apps Environment + Container App
    â”œâ”€â”€ data.bicep          # SQL Server + Database
    â”œâ”€â”€ messaging.bicep     # Service Bus Namespace
    â””â”€â”€ web.bicep           # Static Web App
```

## Validation Status

| Check          | Status      | Notes                                    |
| -------------- | ----------- | ---------------------------------------- |
| `bicep build`  | âœ… Passed   | No errors                                |
| `bicep lint`   | âœ… Passed   | 6 warnings (safe-access recommendations) |
| `bicep format` | âœ… Applied  | All files formatted                      |
| AVM modules    | âœ… Verified | 8 modules using latest AVM versions      |

## Resources Created

| Resource                   | AVM Module                       | Version | SKU          | Purpose                |
| -------------------------- | -------------------------------- | ------- | ------------ | ---------------------- |
| Log Analytics Workspace    | `operational-insights/workspace` | 0.15.0  | PerGB2018    | Centralized logging    |
| Application Insights       | `insights/component`             | 0.7.1   | -            | Application monitoring |
| Key Vault                  | `key-vault/vault`                | 0.13.3  | Standard     | Secrets management     |
| Storage Account            | `storage/storage-account`        | 0.31.0  | Standard_LRS | General storage        |
| App Service Plan           | `web/serverfarm`                 | 0.6.0   | B1           | App hosting plan       |
| App Service                | `web/site`                       | 0.21.0  | -            | .NET 8 web app         |
| Container Apps Environment | `app/managed-environment`        | 0.11.3  | Consumption  | Container hosting      |
| Container App              | `app/container-app`              | 0.20.0  | -            | Hello world container  |
| SQL Server                 | `sql/server`                     | 0.21.1  | -            | Database server        |
| SQL Database               | (via sql/server)                 | -       | Basic        | Test database          |
| Service Bus Namespace      | `service-bus/namespace`          | 0.16.1  | Basic        | Message queuing        |
| Static Web App             | `web/static-site`                | 0.9.3   | Free         | Static website hosting |

## Deployment Instructions

### Quick Deploy

```powershell
cd infra/bicep/agent-testing
./deploy.ps1
```

### Manual Deploy

```bash
# Set variables
RG_NAME="rg-agenttest-dev"
LOCATION="swedencentral"

# Create resource group
az group create --name $RG_NAME --location $LOCATION

# Get current user's Object ID for SQL admin
SQL_ADMIN_OID=$(az ad signed-in-user show --query id -o tsv)

# Deploy
az deployment group create \
  --resource-group $RG_NAME \
  --template-file main.bicep \
  --parameters \
    location=$LOCATION \
    environment=dev \
    projectName=agenttest \
    sqlAdminGroupObjectId=$SQL_ADMIN_OID
```

### What-If Preview

```bash
az deployment group what-if \
  --resource-group $RG_NAME \
  --template-file main.bicep \
  --parameters location=swedencentral environment=dev
```

## Key Implementation Notes

### Unique Resource Naming

All resources use a unique suffix generated from `resourceGroup().id`:

```bicep
var uniqueSuffix = uniqueString(resourceGroup().id)
```

This ensures globally unique names for Storage Accounts, Key Vaults, SQL Servers, etc.

### Required Tags

All resources include these mandatory tags:

| Tag            | Value             |
| -------------- | ----------------- |
| Environment    | dev               |
| ManagedBy      | Bicep             |
| Project        | agenttest         |
| Owner          | platform-team     |
| CostCenter     | CC-AGENTOPS       |
| DeploymentDate | (deployment date) |

### AVM Pitfalls Addressed

| Resource           | Pitfall             | Resolution                         |
| ------------------ | ------------------- | ---------------------------------- |
| Log Analytics      | `dailyQuotaGb` type | Used string `'1'`                  |
| Container Apps Env | Logging config      | Used `appLogsConfiguration` object |
| Container App      | Scale settings      | Used `scaleSettings` object        |
| SQL Database       | Availability zone   | Used int `-1`                      |
| Static Web App     | Region limitation   | Hardcoded `westeurope`             |

### Security Configuration

- **Key Vault**: RBAC-enabled, soft delete (7 days for dev)
- **Storage**: HTTPS only, TLS 1.2, no public blob access
- **SQL Server**: Azure AD-only authentication
- **All resources**: Managed identities enabled

## Next Steps

To deploy this infrastructure:

1. **Run the deploy script**:

   ```powershell
   ./deploy.ps1
   ```

2. **Or proceed to Step 6: Deploy** using the `@deploy` agent

---

## References

| Topic                  | Link                                                                                           |
| ---------------------- | ---------------------------------------------------------------------------------------------- |
| Azure Verified Modules | [AVM Index](https://aka.ms/avm/index)                                                          |
| Bicep Best Practices   | [Documentation](https://learn.microsoft.com/azure/azure-resource-manager/bicep/best-practices) |

---

_Implementation reference generated for agent-testing infrastructure._
