# Step 4: Pre-Flight Check - agent-testing

> Generated by bicep-code agent | 2025-02-04

> [!NOTE]
> üìö See [documentation-styling.md](../../.github/agents/_shared/documentation-styling.md) for visual standards.

## Purpose

This pre-flight check validates AVM schemas and identifies potential pitfalls before Bicep code generation.

## AVM Schema Validation Results

| Resource             | AVM Module                               | Version  | Key Parameters                     | Type Notes                           | Region Notes    |
| -------------------- | ---------------------------------------- | -------- | ---------------------------------- | ------------------------------------ | --------------- |
| Log Analytics        | `avm/res/operational-insights/workspace` | `0.15.0` | name, skuName, dailyQuotaGb        | ‚úÖ dailyQuotaGb is `int` type        | All regions     |
| Application Insights | `avm/res/insights/component`             | `0.7.1`  | name, workspaceResourceId          | ‚úÖ Standard params                   | All regions     |
| Key Vault            | `avm/res/key-vault/vault`                | `0.13.3` | name, sku, enableRbacAuthorization | ‚úÖ sku is `string` ('standard')      | All regions     |
| Storage Account      | `avm/res/storage/storage-account`        | `0.31.0` | name, skuName, kind                | ‚úÖ Standard params                   | All regions     |
| App Service Plan     | `avm/res/web/serverfarm`                 | `0.6.0`  | name, skuName, skuCapacity         | ‚úÖ Standard params                   | All regions     |
| App Service          | `avm/res/web/site`                       | `0.21.0` | name, kind, managedIdentities      | ‚úÖ Standard params                   | All regions     |
| Container App Env    | `avm/res/app/managed-environment`        | `0.11.3` | name, appLogsConfiguration         | ‚ö†Ô∏è Use appLogsConfiguration object   | All regions     |
| Container App        | `avm/res/app/container-app`              | `0.20.0` | name, containers, scaleSettings    | ‚ö†Ô∏è Use scaleSettings object          | All regions     |
| SQL Server           | `avm/res/sql/server`                     | `0.21.1` | name, administrators, databases    | ‚ö†Ô∏è Use sku object + availabilityZone | All regions     |
| Service Bus          | `avm/res/service-bus/namespace`          | `0.16.1` | name, skuObject                    | ‚ö†Ô∏è Use skuObject not skuName         | All regions     |
| Static Web App       | `avm/res/web/static-site`                | `0.9.3`  | name, sku, location                | ‚ö†Ô∏è Hardcode `westeurope`             | Limited regions |

## Parameter Type Analysis

### Log Analytics Workspace

```bicep
// Correct usage
dailyQuotaGb: 1  // int type (updated from previous pitfall)
retentionInDays: 30
skuName: 'PerGB2018'
```

### Container Apps Environment

```bicep
// Correct: Use appLogsConfiguration object
appLogsConfiguration: {
  destination: 'azure-monitor'
}
// WRONG: logAnalyticsWorkspaceResourceId parameter (deprecated)
```

### Container App

```bicep
// Correct: Use scaleSettings object
scaleSettings: {
  minReplicas: 0
  maxReplicas: 3
}
// WRONG: flat scaleMinReplicas/scaleMaxReplicas
```

### SQL Server Database

```bicep
// Correct: Use sku object + availabilityZone
databases: [
  {
    name: 'dbname'
    sku: {
      name: 'Basic'
      tier: 'Basic'
    }
    availabilityZone: -1  // Required for no zone preference
  }
]
```

### Service Bus Namespace

```bicep
// Correct: Use skuObject
skuObject: {
  name: 'Basic'
}
// WRONG: skuName: 'Basic'
```

## Region Limitations Identified

| Service        | Limitation                                              | Solution              |
| -------------- | ------------------------------------------------------- | --------------------- |
| Static Web App | Only: westus2, centralus, eastus2, westeurope, eastasia | Hardcode `westeurope` |

## Pitfalls Checklist

- [x] Log Analytics `dailyQuotaGb` - verified as int type in latest AVM
- [x] Container App Env uses `appLogsConfiguration` object
- [x] Container App uses `scaleSettings` object
- [x] SQL Database uses `sku` object + `availabilityZone: -1`
- [x] Service Bus uses `skuObject` not flat `skuName`
- [x] Static Web App location hardcoded to `westeurope`
- [x] Key Vault uses `sku: 'standard'` (string, not object)
- [x] Storage Account uses `skuName: 'Standard_LRS'` (string)

## Ready for Implementation

‚úÖ **YES** - All pitfalls identified and documented. Proceeding to Bicep code generation.

---

## References

| Topic                  | Link                                                            |
| ---------------------- | --------------------------------------------------------------- |
| Azure Verified Modules | [AVM Index](https://aka.ms/avm/index)                           |
| AVM Pitfalls           | [avm-pitfalls.md](../../.github/agents/_shared/avm-pitfalls.md) |

---

_Pre-flight check completed for agent-testing infrastructure._
