# Azure Design Document: Ecommerce Platform

**Version**: 1.0
**Date**: December 17, 2025
**Author**: Generated by Workload Documentation Generator
**Status**: Draft

---

## 1. Introduction

### 1.1 Document Purpose

This design document provides comprehensive technical documentation for the Ecommerce Platform
Azure infrastructure. It serves as a reference for operations teams, auditors, and future
development efforts.

**Intended Audience:**

- Solution Architects
- Operations/SRE Teams
- Security & Compliance Teams
- Development Teams

### 1.2 Project Overview

The Ecommerce Platform is a PCI-DSS aligned, multi-tier e-commerce application designed to support
10,000+ concurrent users. The platform enables online retail operations with secure payment
processing, product catalog search, and asynchronous order processing.

**Business Objectives:**

- Support peak traffic during sales events (10K+ concurrent users)
- Achieve 99.9% availability SLA for revenue-critical operations
- Maintain PCI-DSS compliance for payment processing
- Deliver sub-100ms product search performance

### 1.3 Design Objectives

| Objective      | Target          | Implementation                               |
| -------------- | --------------- | -------------------------------------------- |
| Availability   | 99.9% SLA       | Zone-redundant App Service (P1v4)            |
| Search Latency | <100ms          | Azure Cognitive Search S1                    |
| Security       | PCI-DSS aligned | WAF, private endpoints, network segmentation |
| Scalability    | 10K users       | Auto-scale, Redis caching, async processing  |

### 1.4 Constraints & Assumptions

**Constraints:**

- Single-region deployment (swedencentral) - no geo-DR in initial phase
- Azure AD-only authentication for SQL Server (no SQL auth)
- Premium SKUs required for private endpoint support

**Assumptions:**

- Payment processing handled by external gateway (Stripe/Adyen)
- Static frontend deployed separately via Static Web Apps
- Development/staging environments use reduced SKUs

### 1.5 Stakeholders

| Role               | Team          | Responsibility                           |
| ------------------ | ------------- | ---------------------------------------- |
| Solution Architect | Platform Team | Design approval, architecture governance |
| Operations         | SRE Team      | Day-2 operations, incident response      |
| Security           | InfoSec Team  | Security review, compliance validation   |
| Development        | Product Team  | Application code, feature delivery       |
| Finance            | FinOps        | Cost monitoring, budget approval         |

---

## 2. Azure Architecture Overview

### 2.1 Architecture Diagram

![Architecture Diagram](./06-asbuilt-diagram.png)

**Text Representation:**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         AZURE FRONT DOOR (WAF)                          │
│                    ┌─────────────────────────────────┐                  │
│                    │  OWASP Rules + Bot Protection   │                  │
│                    └─────────────────────────────────┘                  │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
         ┌───────────────────────┴───────────────────────┐
         │                                               │
         ▼                                               ▼
┌─────────────────────┐                    ┌─────────────────────────────┐
│  STATIC WEB APPS    │                    │      VNet: 10.0.0.0/16      │
│  (React SPA)        │                    │                             │
└─────────────────────┘                    │  ┌─────────────────────────┐│
                                           │  │ snet-web (10.0.1.0/24)  ││
                                           │  │  └─ App Service P1v4   ││
                                           │  └──────────┬──────────────┘│
                                           │             │               │
                                           │  ┌──────────▼──────────────┐│
                                           │  │ snet-data (10.0.2.0/24) ││
                                           │  │  ├─ SQL (PE)            ││
                                           │  │  ├─ Redis (PE)          ││
                                           │  │  ├─ Search (PE)         ││
                                           │  │  └─ Service Bus (PE)    ││
                                           │  └──────────┬──────────────┘│
                                           │             │               │
                                           │  ┌──────────▼──────────────┐│
                                           │  │ snet-integration        ││
                                           │  │ (10.0.3.0/24)           ││
                                           │  │  └─ Functions EP1       ││
                                           │  └─────────────────────────┘│
                                           │                             │
                                           │         KEY VAULT           │
                                           └─────────────────────────────┘
```

### 2.2 Subscription & Resource Organization

| Level          | Name                      | Purpose                 |
| -------------- | ------------------------- | ----------------------- |
| Subscription   | Production                | Production workloads    |
| Resource Group | rg-ecommerce-prod-swc-001 | All ecommerce resources |

### 2.3 Region Selection

| Region             | Role           | Rationale                                                  |
| ------------------ | -------------- | ---------------------------------------------------------- |
| swedencentral      | Primary        | GDPR compliance, sustainable operations, EU data residency |
| germanywestcentral | DR (future)    | Geographic redundancy, German data residency option        |
| westeurope         | Static Web App | Limited region availability for SWA                        |

### 2.4 Naming Conventions

Resources follow Cloud Adoption Framework (CAF) naming standards:

```
{resource-type}-{project}-{environment}-{region}-{instance}
```

| Resource Type   | Pattern                                      | Example                              |
| --------------- | -------------------------------------------- | ------------------------------------ |
| Virtual Network | `vnet-{project}-{env}-{region}-{###}`        | `vnet-ecommerce-prod-swc-001`        |
| App Service     | `app-{project}-{role}-{env}-{region}-{###}`  | `app-ecommerce-api-prod-swc-001`     |
| Key Vault       | `kv-{project}-{env}-{suffix}`                | `kv-ecom-prod-abc123`                |
| SQL Server      | `sql-{project}-{env}-{region}-{suffix}`      | `sql-ecommerce-prod-swc-abc123`      |
| Function App    | `func-{project}-{role}-{env}-{region}-{###}` | `func-ecommerce-orders-prod-swc-001` |

### 2.5 Tagging Strategy

| Tag           | Purpose                 | Example                  |
| ------------- | ----------------------- | ------------------------ |
| `Environment` | Deployment stage        | `prod`, `staging`, `dev` |
| `ManagedBy`   | IaC tool identifier     | `Bicep`                  |
| `Project`     | Workload identifier     | `ecommerce-platform`     |
| `Owner`       | Responsible team        | `platform-team`          |
| `CostCenter`  | Billing allocation      | `CC-ECOM-001`            |
| `Compliance`  | Regulatory requirements | `PCI-DSS`                |
| `Region`      | Deployment region       | `swedencentral`          |

---

## 3. Networking

### 3.1 Network Topology

The platform uses a hub-less single-VNet design with three-tier subnet segmentation:

- **Web Tier**: Public-facing application workloads
- **Data Tier**: Backend data services with private endpoints
- **Integration Tier**: Async processing and messaging

### 3.2 Virtual Networks

| VNet Name                   | Address Space | Region        | Purpose                  |
| --------------------------- | ------------- | ------------- | ------------------------ |
| vnet-ecommerce-prod-swc-001 | 10.0.0.0/16   | swedencentral | Primary workload network |

### 3.3 Subnets

| Subnet                | Address Range | NSG                          | Delegation                | Purpose                                             |
| --------------------- | ------------- | ---------------------------- | ------------------------- | --------------------------------------------------- |
| snet-web-prod         | 10.0.1.0/24   | nsg-web-prod-swc-001         | Microsoft.Web/serverFarms | App Service VNet integration                        |
| snet-data-prod        | 10.0.2.0/24   | nsg-data-prod-swc-001        | None                      | Private endpoints (SQL, Redis, Search, Service Bus) |
| snet-integration-prod | 10.0.3.0/24   | nsg-integration-prod-swc-001 | Microsoft.Web/serverFarms | Azure Functions VNet integration                    |

### 3.4 Network Security Groups

**NSG Rules Summary:**

| NSG             | Key Rules                                           | Priority |
| --------------- | --------------------------------------------------- | -------- |
| nsg-web         | Allow HTTPS from AFD, Allow outbound to data subnet | 100-200  |
| nsg-data        | Allow from web/integration subnets only             | 100-200  |
| nsg-integration | Allow Service Bus, Allow Key Vault                  | 100-200  |
| All NSGs        | Deny all (default)                                  | 4096     |

_Full NSG rule details in [Appendix 10.3](#103-nsg-rules-detail)_

### 3.5 DNS Configuration

| Private DNS Zone                    | Linked to VNet | Purpose                           |
| ----------------------------------- | -------------- | --------------------------------- |
| privatelink.database.windows.net    | ✅             | SQL Server private endpoint       |
| privatelink.redis.cache.windows.net | ✅             | Redis Cache private endpoint      |
| privatelink.search.windows.net      | ✅             | Cognitive Search private endpoint |
| privatelink.servicebus.windows.net  | ✅             | Service Bus private endpoint      |
| privatelink.vaultcore.azure.net     | ✅             | Key Vault private endpoint        |

### 3.6 Connectivity

| Connection Type  | Source      | Destination      | Method                              |
| ---------------- | ----------- | ---------------- | ----------------------------------- |
| Internet Ingress | Users       | Front Door       | Azure Front Door Premium            |
| Frontend to API  | Front Door  | App Service      | Private endpoint (via AFD)          |
| API to Data      | App Service | SQL/Redis/Search | Private endpoints                   |
| Async Processing | Service Bus | Functions        | Private endpoint + VNet integration |

---

## 4. Storage

### 4.1 Storage Accounts

| Account                   | SKU      | Replication | Purpose                               |
| ------------------------- | -------- | ----------- | ------------------------------------- |
| stecommerceprod{suffix}   | Standard | LRS         | Function App storage, diagnostic logs |
| stecommerceimages{suffix} | Standard | LRS         | Product images (CDN-backed)           |

### 4.2 Encryption

| Resource         | Encryption Type      | Key Management         |
| ---------------- | -------------------- | ---------------------- |
| Storage Accounts | AES-256 at rest      | Microsoft-managed keys |
| SQL Database     | TDE enabled          | Microsoft-managed keys |
| Redis Cache      | In-transit TLS 1.2   | N/A                    |
| Service Bus      | At rest + in transit | Microsoft-managed keys |

### 4.3 Access Controls

| Resource            | Access Method    | Authentication          |
| ------------------- | ---------------- | ----------------------- |
| Storage (Functions) | Managed Identity | System-assigned MI      |
| Storage (Images)    | CDN + SAS        | Time-limited SAS tokens |
| Blob Public Access  | Disabled         | N/A                     |

---

## 5. Compute

### 5.1 Compute Resources

| Resource                           | Type             | SKU      | Instances          | Purpose            |
| ---------------------------------- | ---------------- | -------- | ------------------ | ------------------ |
| asp-ecommerce-prod-swc-001         | App Service Plan | P1v4     | 2 (zone redundant) | API hosting        |
| app-ecommerce-api-prod-swc-001     | App Service      | P1v4     | 2                  | .NET 8 REST API    |
| asp-func-ecommerce-prod-swc-001    | App Service Plan | EP1      | 1-10 (elastic)     | Functions hosting  |
| func-ecommerce-orders-prod-swc-001 | Function App     | EP1      | Auto-scale         | Order processing   |
| swa-ecommerce-prod-swc-001         | Static Web App   | Standard | N/A                | React SPA frontend |

### 5.2 Scaling Configuration

| Resource     | Scale Type  | Min | Max | Trigger                 |
| ------------ | ----------- | --- | --- | ----------------------- |
| App Service  | Manual/Auto | 2   | 12  | CPU > 70%, Memory > 80% |
| Function App | Elastic     | 1   | 10  | Queue length, CPU       |

**Recommended Auto-Scale Rules:**

```
Scale Out: CPU% > 70 for 5 minutes → +1 instance
Scale Out: HTTP Queue > 100 → +1 instance
Scale In: CPU% < 30 for 10 minutes → -1 instance
```

### 5.3 Availability

| Resource         | Availability Configuration    | SLA    |
| ---------------- | ----------------------------- | ------ |
| App Service P1v4 | Zone redundant (2+ instances) | 99.95% |
| Function App EP1 | Zone redundant                | 99.95% |
| Static Web App   | Global edge distribution      | 99.95% |
| SQL Database S3  | Zone redundant storage        | 99.99% |

---

## 6. Identity & Access

### 6.1 Authentication

| Component    | Auth Method      | Provider               |
| ------------ | ---------------- | ---------------------- |
| SQL Server   | Azure AD-only    | Azure Active Directory |
| App Service  | Managed Identity | System-assigned        |
| Function App | Managed Identity | System-assigned        |
| Admin Access | Azure AD + MFA   | Conditional Access     |

### 6.2 Authorization (RBAC)

| Principal                 | Role                            | Scope            |
| ------------------------- | ------------------------------- | ---------------- |
| App Service MI            | Key Vault Secrets User          | Key Vault        |
| App Service MI            | Azure Service Bus Data Sender   | Service Bus      |
| App Service MI            | Search Index Data Reader        | Cognitive Search |
| Function App MI           | Key Vault Secrets User          | Key Vault        |
| Function App MI           | Azure Service Bus Data Receiver | Service Bus      |
| Function App MI           | SQL DB Contributor              | SQL Database     |
| sql-admins (AAD Group)    | SQL Server Administrator        | SQL Server       |
| platform-team (AAD Group) | Contributor                     | Resource Group   |

### 6.3 Managed Identities

| Resource                   | Identity Type   | Purpose                               |
| -------------------------- | --------------- | ------------------------------------- |
| app-ecommerce-api-prod     | System-assigned | Access Key Vault, Service Bus, Search |
| func-ecommerce-orders-prod | System-assigned | Access Key Vault, Service Bus, SQL    |

### 6.4 Service Principals

No application registrations required - all service-to-service auth uses managed identities.

---

## 7. Security & Compliance

### 7.1 Security Baseline

**Azure Security Benchmark Alignment:**

| Control                      | Implementation                      | Status |
| ---------------------------- | ----------------------------------- | ------ |
| NS-1: Network Segmentation   | 3-tier subnet isolation, NSGs       | ✅     |
| NS-2: Secure Cloud Services  | Private endpoints for all PaaS      | ✅     |
| IM-1: Centralized Identity   | Azure AD-only, no local accounts    | ✅     |
| IM-3: Managed Identities     | System-assigned MI for all services | ✅     |
| DP-3: Encrypt Sensitive Data | TLS 1.2+, encryption at rest        | ✅     |
| LT-4: Logging for Security   | Log Analytics, 90-day retention     | ✅     |

### 7.2 Network Security

| Layer       | Protection        | Implementation                        |
| ----------- | ----------------- | ------------------------------------- |
| Edge        | WAF + DDoS        | Azure Front Door Premium, OWASP rules |
| Perimeter   | Network Isolation | VNet, private endpoints               |
| Network     | Segmentation      | NSGs with deny-by-default             |
| Application | TLS Enforcement   | Minimum TLS 1.2                       |

### 7.3 Data Protection

| Data Type    | Protection              | Location                  |
| ------------ | ----------------------- | ------------------------- |
| Customer PII | Encrypted at rest (TDE) | SQL Database              |
| Session Data | In-transit encryption   | Redis (TLS)               |
| Secrets      | Key Vault storage       | Key Vault (HSM-backed)    |
| Payment Data | External tokenization   | Stripe/Adyen (not stored) |

### 7.4 Compliance Requirements

| Requirement | Implementation                        | Evidence                    |
| ----------- | ------------------------------------- | --------------------------- |
| PCI-DSS     | WAF, network segmentation, encryption | Penetration test reports    |
| GDPR        | EU data residency (swedencentral)     | Data residency confirmation |
| SOC 2       | Azure compliance inheritance          | Azure SOC 2 report          |

### 7.5 Azure Policy

Governance policies applied at resource group level:

| Policy                        | Effect | Purpose                |
| ----------------------------- | ------ | ---------------------- |
| Require HTTPS for App Service | Deny   | Enforce TLS            |
| Require private endpoints     | Audit  | Track compliance       |
| Require tags                  | Deny   | Enforce tagging        |
| Allowed locations             | Deny   | Restrict to EU regions |

---

## 8. Backup & Disaster Recovery

### 8.1 Backup Strategy

| Resource          | Backup Method       | Retention     | RPO       |
| ----------------- | ------------------- | ------------- | --------- |
| SQL Database      | Automated backups   | 7 days (PITR) | 5 minutes |
| SQL Database      | Long-term retention | 1 year        | Weekly    |
| Key Vault         | Soft delete enabled | 90 days       | N/A       |
| Storage Account   | Blob versioning     | 30 days       | Immediate |
| App Configuration | Export to Git       | On change     | N/A       |

### 8.2 Disaster Recovery

| Metric | Target  | Current         | Gap                      |
| ------ | ------- | --------------- | ------------------------ |
| RTO    | 4 hours | 4-8 hours       | Requires geo-replication |
| RPO    | 1 hour  | 5 minutes (SQL) | ✅ Met                   |

**Current DR Posture:**

- ⚠️ Single-region deployment (no automatic failover)
- ✅ Zone-redundant compute (survives AZ failure)
- ⚠️ SQL geo-replication not configured
- ✅ Front Door can redirect to secondary (when available)

### 8.3 Failover Procedures

**High-Level Recovery Process:**

1. Detect failure via Azure Monitor alerts
2. Assess scope (AZ vs region vs service)
3. If region failure: Deploy to germanywestcentral from Bicep
4. Restore SQL from geo-backup
5. Update Front Door origin
6. Validate application health
7. Communicate to stakeholders

_Detailed procedures in [07-backup-dr-plan.md](./07-backup-dr-plan.md) (if generated)_

---

## 9. Management & Monitoring

### 9.1 Monitoring Strategy

| Component               | Tool                 | Purpose                          |
| ----------------------- | -------------------- | -------------------------------- |
| Application Performance | Application Insights | Traces, dependencies, exceptions |
| Infrastructure          | Log Analytics        | Resource logs, metrics           |
| Availability            | Azure Monitor        | Uptime, SLA tracking             |
| Security                | Microsoft Defender   | Threat detection                 |

### 9.2 Alerting

| Alert             | Condition                          | Severity | Action Group   |
| ----------------- | ---------------------------------- | -------- | -------------- |
| High CPU          | App Service CPU > 80% for 5 min    | Sev 2    | ops-team-email |
| High Memory       | App Service Memory > 85% for 5 min | Sev 2    | ops-team-email |
| Failed Requests   | HTTP 5xx > 10/min                  | Sev 1    | ops-team-pager |
| SQL DTU           | DTU utilization > 90%              | Sev 2    | ops-team-email |
| Queue Backlog     | Service Bus messages > 1000        | Sev 3    | ops-team-email |
| Function Failures | Function exceptions > 5/min        | Sev 2    | ops-team-email |

### 9.3 Diagnostics

All resources send diagnostic logs to Log Analytics:

| Resource     | Log Categories                                      | Retention |
| ------------ | --------------------------------------------------- | --------- |
| App Service  | AppServiceHTTPLogs, AppServiceConsoleLogs           | 90 days   |
| Function App | FunctionAppLogs                                     | 90 days   |
| SQL Database | SQLSecurityAuditEvents, QueryStoreRuntimeStatistics | 90 days   |
| Key Vault    | AuditEvent                                          | 90 days   |
| Front Door   | FrontDoorAccessLog, FrontDoorHealthProbeLog         | 90 days   |

### 9.4 Maintenance

| Task                | Frequency | Method                  |
| ------------------- | --------- | ----------------------- |
| OS Patching         | Automatic | Platform-managed (PaaS) |
| Runtime Updates     | Quarterly | Deployment slots        |
| Certificate Renewal | Automatic | App Service managed     |
| Secret Rotation     | 90 days   | Key Vault + CI/CD       |
| Dependency Updates  | Monthly   | Dependabot + PR review  |

---

## 10. Appendix

### 10.1 Full Resource Inventory

See [07-resource-inventory.md](./07-resource-inventory.md)

### 10.2 IP Address Allocation

| Subnet                | Range       | Available IPs | Used      |
| --------------------- | ----------- | ------------- | --------- |
| snet-web-prod         | 10.0.1.0/24 | 251           | ~10       |
| snet-data-prod        | 10.0.2.0/24 | 251           | ~15 (PEs) |
| snet-integration-prod | 10.0.3.0/24 | 251           | ~5        |

### 10.3 NSG Rules Detail

**nsg-web-prod-swc-001:**

| Priority | Name             | Source                 | Dest | Port | Action |
| -------- | ---------------- | ---------------------- | ---- | ---- | ------ |
| 100      | AllowAFD         | AzureFrontDoor.Backend | Any  | 443  | Allow  |
| 200      | AllowHealthProbe | AzureLoadBalancer      | Any  | \*   | Allow  |
| 4096     | DenyAllInbound   | Any                    | Any  | \*   | Deny   |

**nsg-data-prod-swc-001:**

| Priority | Name                   | Source      | Dest | Port | Action |
| -------- | ---------------------- | ----------- | ---- | ---- | ------ |
| 100      | AllowWebSubnet         | 10.0.1.0/24 | Any  | 443  | Allow  |
| 110      | AllowIntegrationSubnet | 10.0.3.0/24 | Any  | 443  | Allow  |
| 4096     | DenyAllInbound         | Any         | Any  | \*   | Deny   |

### 10.4 Cost Breakdown

See [03-des-cost-estimate.md](./03-des-cost-estimate.md)

**Summary:** ~$1,595/month | ~$19,140/year

### 10.5 Architecture Decision Records

- No ADRs currently generated for this project
- Use `adr` agent to create decision records

### 10.6 References

- [Azure Well-Architected Framework](https://learn.microsoft.com/azure/well-architected/)
- [Cloud Adoption Framework](https://learn.microsoft.com/azure/cloud-adoption-framework/)
- [Azure Architecture Center](https://learn.microsoft.com/azure/architecture/)
- [PCI-DSS on Azure](https://learn.microsoft.com/azure/compliance/offerings/offering-pci-dss)
- [Azure Security Benchmark](https://learn.microsoft.com/security/benchmark/azure/)
